<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Slideshow</title>
    <style>
        body {
            background: #000;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            cursor: default;
        }

        img#slideshow {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            object-fit: contain;
        }

        #controls {
            position: absolute;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            max-height: 90vh;
            overflow-y: auto;
            min-width: 600px;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }

        #loadingOverlay.active {
            display: flex;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            width: 100%;
            border-bottom: 2px solid #333;
        }

        .tab-button {
            flex: 1;
            padding: 15px 30px;
            font-size: 20px;
            background: rgba(255, 255, 255, 0.05);
            color: #aaa;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            font-family: Arial, sans-serif;
        }

        .tab-button:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .tab-content {
            display: none;
            width: 100%;
            gap: 15px;
            flex-direction: column;
            align-items: center;
        }

        .tab-content.active {
            display: flex;
        }

        .spinner {
            border: 8px solid #333;
            border-top: 8px solid #4CAF50;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingText {
            color: #fff;
            font-size: 24px;
            font-family: Arial, sans-serif;
        }

        #startFolderSelect, #speedSelect {
            padding: 10px 20px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background: #ffffffdd;
            color: #000;
            cursor: pointer;
            min-width: 250px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        #randomizeCheckbox, #shuffleAllCheckbox, #randomizeMusicCheckbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        #startButton {
            padding: 15px 40px;
            font-size: 26px;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            background: #4CAF50;
            color: #fff;
            font-weight: bold;
            margin-top: 20px;
            width: 100%;
            transition: background 0.3s;
        }

        #startButton:hover {
            background: #45a049;
        }

        #startButton:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        label {
            color: #fff;
            font-size: 18px;
            font-family: Arial, sans-serif;
        }

        #musicList, #folderList {
            max-height: 350px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            width: 100%;
        }

        .music-item, .folder-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: move;
            transition: background 0.2s;
        }

        .music-item:hover, .folder-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .music-item.dragging, .folder-item.dragging {
            opacity: 0.5;
            background: rgba(76, 175, 80, 0.3);
        }

        .music-item.drag-over, .folder-item.drag-over {
            border-top: 3px solid #4CAF50;
        }

        .drag-handle {
            cursor: move;
            font-size: 18px;
            color: #aaa;
        }

        .music-item input[type="checkbox"],
        .folder-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .music-item label,
        .folder-item label {
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }

        #selectAllMusic, #selectNoMusic,
        #selectAllFolders, #selectNoFolders {
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #2196F3;
            color: #fff;
            margin: 5px;
        }

        #selectNoMusic, #selectNoFolders {
            background: #f44336;
        }

        .music-controls, .folder-controls {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .error-message {
            color: #ff6b6b;
            font-size: 14px;
            padding: 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 5px;
            border: 1px solid #ff6b6b;
            display: none;
            width: 100%;
            text-align: center;
        }

        .error-message.show {
            display: block;
        }

        /* Fullscreen styles */
        body:-webkit-full-screen {
            width: 100%;
            height: 100%;
        }
        body:-moz-full-screen {
            width: 100%;
            height: 100%;
        }
        body:-ms-fullscreen {
            width: 100%;
            height: 100%;
        }
        body:fullscreen {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Preloading images...</div>
    </div>

    <div id="controls">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" data-tab="photos">üì∑ Photo Settings</button>
            <button class="tab-button" data-tab="music">üéµ Music Settings</button>
        </div>

        <!-- Photos Tab -->
        <div class="tab-content active" id="photos-tab">
            <label>Select Folders (drag to reorder, at least one required):</label>
            <div class="folder-controls">
                <button id="selectAllFolders">Select All</button>
                <button id="selectNoFolders">Deselect All</button>
            </div>
            <div id="folderList">
                <p style="color: #aaa;">Loading folders...</p>
            </div>
            <div class="error-message" id="folderError">‚ö†Ô∏è Please select at least one folder</div>

            <label for="startFolderSelect">Starting folder (optional):</label>
            <select id="startFolderSelect">
                <option value="">None (use folder order above)</option>
            </select>
            
            <div class="checkbox-container">
                <input type="checkbox" id="shuffleAllCheckbox">
                <label for="shuffleAllCheckbox">Shuffle ALL images together (ignore folders)</label>
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="randomizeCheckbox" checked>
                <label for="randomizeCheckbox">Randomise images within folders</label>
            </div>

            <label for="speedSelect">Image display duration:</label>
            <select id="speedSelect">
                <option value="500">Very Very Quick (0.5 second)</option>
                <option value="1000">Very Quick (1 second)</option>
                <option value="2000">Fast (2 seconds)</option>
                <option value="3000">Medium (3 seconds)</option>
                <option value="5000" selected>Normal (5 seconds)</option>
                <option value="7000">Slow (7 seconds)</option>
                <option value="10000">Very Slow (10 seconds)</option>
            </select>
        </div>

        <!-- Music Tab -->
        <div class="tab-content" id="music-tab">
            <label>Select Music (drag to reorder):</label>
            <div class="music-controls">
                <button id="selectAllMusic">Select All</button>
                <button id="selectNoMusic">No Music</button>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="randomizeMusicCheckbox">
                <label for="randomizeMusicCheckbox">Randomize music order</label>
            </div>
            <div id="musicList">
                <p style="color: #aaa;">Loading music...</p>
            </div>
        </div>
        
        <button id="startButton">Start Slideshow</button>
        
        <div style="color: #aaa; font-size: 14px; text-align: center; margin-top: 10px;">
            <p>Controls: Space/P = Pause/Play | ‚Üê ‚Üí = Previous/Next</p>
        </div>
    </div>
    
    <img id="slideshow" src="" alt="Slideshow Image"/>
    <audio id="audioPlayer" preload="auto" style="display: none;"></audio>

    <script>
        const imgEl = document.getElementById("slideshow");
        const startBtn = document.getElementById("startButton");
        const startFolderSelect = document.getElementById("startFolderSelect");
        const randomizeCheckbox = document.getElementById("randomizeCheckbox");
        const shuffleAllCheckbox = document.getElementById("shuffleAllCheckbox");
        const randomizeMusicCheckbox = document.getElementById("randomizeMusicCheckbox");
        const speedSelect = document.getElementById("speedSelect");
        const controls = document.getElementById("controls");
        const musicList = document.getElementById("musicList");
        const folderList = document.getElementById("folderList");
        const selectAllMusicBtn = document.getElementById("selectAllMusic");
        const selectNoMusicBtn = document.getElementById("selectNoMusic");
        const selectAllFoldersBtn = document.getElementById("selectAllFolders");
        const selectNoFoldersBtn = document.getElementById("selectNoFolders");
        const audioPlayer = document.getElementById("audioPlayer");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");
        const folderError = document.getElementById("folderError");
        
        let images = [];
        let musicFiles = [];
        let folderFiles = [];
        let selectedMusic = [];
        let currentMusicIndex = 0;
        let index = 0;
        let delay = 5000;
        let intervalId;
        let wakeLock = null;
        let keepAwakeInterval;
        let imageCache = new Map();
        const PRELOAD_COUNT = 5;
        let draggedElement = null;
        let isPaused = false;
        let slideshowStarted = false;

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(targetTab + '-tab').classList.add('active');
            });
        });

        // When shuffleAll is checked, disable folder selection and randomize
        shuffleAllCheckbox.addEventListener('change', function() {
            if (this.checked) {
                folderList.style.opacity = '0.5';
                folderList.style.pointerEvents = 'none';
                startFolderSelect.disabled = true;
                randomizeCheckbox.disabled = true;
                startFolderSelect.style.opacity = '0.5';
                folderError.classList.remove('show');
                startBtn.disabled = false;
            } else {
                folderList.style.opacity = '1';
                folderList.style.pointerEvents = 'auto';
                startFolderSelect.disabled = false;
                randomizeCheckbox.disabled = false;
                startFolderSelect.style.opacity = '1';
                validateFolderSelection();
            }
        });

        // Validate folder selection and update start button
        function validateFolderSelection() {
            if (shuffleAllCheckbox.checked) {
                startBtn.disabled = false;
                folderError.classList.remove('show');
                return true;
            }
            
            const selectedFolders = getSelectedFolders();
            if (selectedFolders.length === 0) {
                startBtn.disabled = true;
                folderError.classList.add('show');
                return false;
            } else {
                startBtn.disabled = false;
                folderError.classList.remove('show');
                return true;
            }
        }

        // Load folder list
        async function loadFolders() {
            try {
                const response = await fetch("/api/folders/list");
                folderFiles = await response.json();
                
                folderList.innerHTML = '';
                startFolderSelect.innerHTML = '<option value="">None (use folder order above)</option>';
                
                if (folderFiles.length === 0) {
                    folderList.innerHTML = '<p style="color: #aaa;">No folders found</p>';
                    return;
                }
                
                folderFiles.forEach((folder, idx) => {
                    createFolderItem(folder, idx);
                    
                    // Add to start folder dropdown
                    const option = document.createElement("option");
                    option.value = folder;
                    option.textContent = folder;
                    startFolderSelect.appendChild(option);
                });
                
                validateFolderSelection();
            } catch (err) {
                console.error("Error loading folders:", err);
            }
        }

        function createFolderItem(folder, idx) {
            const div = document.createElement("div");
            div.className = "folder-item";
            div.draggable = true;
            div.dataset.folder = folder;
            
            const dragHandle = document.createElement("span");
            dragHandle.className = "drag-handle";
            dragHandle.innerHTML = "‚ãÆ‚ãÆ";
            
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `folder-${idx}`;
            checkbox.value = folder;
            checkbox.checked = true; // Select all by default
            checkbox.addEventListener('change', validateFolderSelection);
            
            const label = document.createElement("label");
            label.htmlFor = `folder-${idx}`;
            label.textContent = folder;
            
            div.appendChild(dragHandle);
            div.appendChild(checkbox);
            div.appendChild(label);
            
            // Drag and drop events
            div.addEventListener('dragstart', handleFolderDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleFolderDrop);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragenter', handleDragEnter);
            div.addEventListener('dragleave', handleDragLeave);
            
            folderList.appendChild(div);
        }

        // Get selected folders in order
        function getSelectedFolders() {
            const items = folderList.querySelectorAll('.folder-item');
            const selected = [];
            
            items.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            
            return selected;
        }

        // Select all folders
        selectAllFoldersBtn.addEventListener('click', () => {
            const checkboxes = folderList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            validateFolderSelection();
        });

        // Deselect all folders
        selectNoFoldersBtn.addEventListener('click', () => {
            const checkboxes = folderList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            validateFolderSelection();
        });

        // Load music list
        async function loadMusicFiles() {
            try {
                const response = await fetch("/api/music/list");
                musicFiles = await response.json();
                
                musicList.innerHTML = '';
                
                if (musicFiles.length === 0) {
                    musicList.innerHTML = '<p style="color: #aaa;">No music files found</p>';
                    return;
                }
                
                musicFiles.forEach((file, idx) => {
                    createMusicItem(file, idx);
                });
            } catch (err) {
                console.error("Error loading music:", err);
                musicList.innerHTML = '<p style="color: #aaa;">Error loading music files</p>';
            }
        }

        function createMusicItem(file, idx) {
            const div = document.createElement("div");
            div.className = "music-item";
            div.draggable = true;
            div.dataset.file = file;
            
            const dragHandle = document.createElement("span");
            dragHandle.className = "drag-handle";
            dragHandle.innerHTML = "‚ãÆ‚ãÆ";
            
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `music-${idx}`;
            checkbox.value = file;
            
            const label = document.createElement("label");
            label.htmlFor = `music-${idx}`;
            label.textContent = file;
            
            div.appendChild(dragHandle);
            div.appendChild(checkbox);
            div.appendChild(label);
            
            // Drag and drop events
            div.addEventListener('dragstart', handleMusicDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleMusicDrop);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragenter', handleDragEnter);
            div.addEventListener('dragleave', handleDragLeave);
            
            musicList.appendChild(div);
        }

        // Drag handlers for folders
        function handleFolderDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleFolderDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const allItems = [...folderList.querySelectorAll('.folder-item')];
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }
            }
            
            this.classList.remove('drag-over');
            return false;
        }

        // Drag handlers for music
        function handleMusicDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleMusicDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const allItems = [...musicList.querySelectorAll('.music-item')];
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }
            }
            
            this.classList.remove('drag-over');
            return false;
        }

        // Common drag handlers
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            const items = this.parentNode.querySelectorAll('.music-item, .folder-item');
            items.forEach(item => item.classList.remove('drag-over'));
        }

        // Select all music
        selectAllMusicBtn.addEventListener('click', () => {
            const checkboxes = musicList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        });

        // Select no music
        selectNoMusicBtn.addEventListener('click', () => {
            const checkboxes = musicList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        });

        // Get selected music in order
        function getSelectedMusic() {
            const items = musicList.querySelectorAll('.music-item');
            const selected = [];
            
            items.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            
            // Randomize if checkbox is checked
            if (randomizeMusicCheckbox.checked && selected.length > 0) {
                for (let i = selected.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [selected[i], selected[j]] = [selected[j], selected[i]];
                }
                console.log('Music randomized');
            }
            
            return selected;
        }

        // Play music playlist
        function playMusic() {
            selectedMusic = getSelectedMusic();
            
            if (selectedMusic.length === 0) {
                console.log('No music selected');
                return;
            }
            
            console.log('Playlist order:', selectedMusic);
            currentMusicIndex = 0;
            playCurrentTrack();
            
            // When track ends, play next
            audioPlayer.addEventListener('ended', () => {
                currentMusicIndex = (currentMusicIndex + 1) % selectedMusic.length;
                playCurrentTrack();
            });
        }

        function playCurrentTrack() {
            if (selectedMusic.length === 0) return;
            
            const track = selectedMusic[currentMusicIndex];
            audioPlayer.src = '/music/' + track;
            audioPlayer.load();
            audioPlayer.play().catch(err => console.error('Audio play error:', err));
            console.log('Playing:', track);
        }

        function togglePause() {
            if (!slideshowStarted) return;
            
            isPaused = !isPaused;
            
            if (isPaused) {
                clearInterval(intervalId);
                
                if (!audioPlayer.paused) {
                    audioPlayer.pause();
                    console.log('Music paused');
                }
                
                console.log('Slideshow paused');
            } else {
                intervalId = setInterval(nextImage, delay);
                
                if (selectedMusic.length > 0) {
                    audioPlayer.play().catch(err => console.error('Audio resume error:', err));
                    console.log('Music resumed');
                }
                
                console.log('Slideshow resumed');
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (!slideshowStarted) return;
            
            switch(e.key) {
                case ' ':
                case 'p':
                case 'P':
                    e.preventDefault();
                    togglePause();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (isPaused) {
                        nextImage();
                    }
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (isPaused) {
                        previousImage();
                    }
                    break;
            }
        });

        function previousImage() {
            index = (index - 1 + images.length) % images.length;
            showImage(index);
        }

        async function loadImages() {
            console.log('Loading images...');
            const startFolder = startFolderSelect.value;
            const randomize = randomizeCheckbox.checked;
            const shuffleAll = shuffleAllCheckbox.checked;
            const selectedFolders = getSelectedFolders();
            
            const requestBody = {
                startFolder: startFolder || null,
                randomize: randomize,
                shuffleAll: shuffleAll,
                selectedFolders: shuffleAll ? [] : selectedFolders
            };
            
            console.log('Request body:', requestBody);
            
            const response = await fetch('/api/images/list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            images = await response.json();
            console.log('Images loaded:', images.length);
            
            preloadImages(0, Math.min(PRELOAD_COUNT, images.length));
        }

        function preloadImages(startIndex, count) {
            for (let i = 0; i < count; i++) {
                const imageIndex = (startIndex + i) % images.length;
                const url = "/images/" + images[imageIndex];
                
                if (imageCache.has(url)) {
                    continue;
                }
                
                const img = new Image();
                img.onload = () => {
                    console.log('Preloaded:', images[imageIndex]);
                };
                img.onerror = () => {
                    console.error('Failed to preload:', images[imageIndex]);
                };
                img.src = url;
                imageCache.set(url, img);
            }
            
            if (imageCache.size > PRELOAD_COUNT * 2) {
                const keysToDelete = [];
                let deleteCount = 0;
                for (const key of imageCache.keys()) {
                    if (deleteCount++ < imageCache.size - PRELOAD_COUNT * 2) {
                        keysToDelete.push(key);
                    } else {
                        break;
                    }
                }
                keysToDelete.forEach(key => imageCache.delete(key));
            }
        }

        function showImage(i) {
            const url = "/images/" + images[i];
            
            if (imageCache.has(url)) {
                imgEl.src = imageCache.get(url).src;
            } else {
                imgEl.src = url;
            }
            
            const nextBatchStart = (i + 1) % images.length;
            preloadImages(nextBatchStart, PRELOAD_COUNT);
        }

        function nextImage() {
            index = (index + 1) % images.length;
            showImage(index);
        }

        async function requestFullscreen() {
            try {
                if (document.documentElement.requestFullscreen) {
                    await document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    await document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    await document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    await document.documentElement.msRequestFullscreen();
                }
                console.log('Fullscreen active');
            } catch (err) {
                console.log('Fullscreen error:', err);
            }
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                    });
                }
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
        }

        function simulateActivity() {
            const event = new MouseEvent('mousemove', {
                view: window,
                bubbles: true,
                cancelable: true,
                clientX: 1,
                clientY: 1
            });
            document.dispatchEvent(event);
        }

        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                console.log('Exited fullscreen');
            }
        });

        startBtn.addEventListener("click", async () => {
            if (!validateFolderSelection()) {
                return;
            }
            
            delay = parseInt(speedSelect.value);
            
            controls.style.display = "none";
            loadingOverlay.classList.add("active");
            document.body.style.cursor = "none";
            
            await requestFullscreen();
            await requestWakeLock();
            
            keepAwakeInterval = setInterval(simulateActivity, 30000);
            
            playMusic();
            
            await loadImages();
            
            let preloadedCount = 0;
            const checkInterval = setInterval(() => {
                preloadedCount = imageCache.size;
                loadingText.textContent = `Preloading images... (${preloadedCount}/${Math.min(PRELOAD_COUNT, images.length)})`;
                
                if (preloadedCount >= Math.min(PRELOAD_COUNT, images.length) || preloadedCount >= images.length) {
                    clearInterval(checkInterval);
                    loadingOverlay.classList.remove("active");
                    
                    if (images.length > 0) {
                        slideshowStarted = true;
                        showImage(0);
                        intervalId = setInterval(nextImage, delay);
                    }
                }
            }, 100);
        });

        window.addEventListener('beforeunload', () => {
            if (wakeLock !== null) {
                wakeLock.release();
            }
            if (keepAwakeInterval) {
                clearInterval(keepAwakeInterval);
            }
        });

        // Load folders and music on page load
        loadFolders();
        loadMusicFiles();
    </script>

</body>
</html>