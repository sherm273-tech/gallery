<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Slideshow</title>
    <style>
        body {
            background: #000;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            cursor: default;
        }

        img#slideshow {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            object-fit: contain;
        }

        #controls {
            position: absolute;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }

        #loadingOverlay.active {
            display: flex;
        }

        .spinner {
            border: 8px solid #333;
            border-top: 8px solid #4CAF50;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingText {
            color: #fff;
            font-size: 24px;
            font-family: Arial, sans-serif;
        }

        #folderSelect, #speedSelect {
            padding: 10px 20px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background: #ffffffdd;
            color: #000;
            cursor: pointer;
            min-width: 250px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #randomizeCheckbox, #shuffleAllCheckbox, #randomizeMusicCheckbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        #startButton {
            padding: 15px 30px;
            font-size: 24px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: #fff;
            font-weight: bold;
        }

        #startButton:hover {
            background: #45a049;
        }

        label {
            color: #fff;
            font-size: 18px;
            font-family: Arial, sans-serif;
        }

        #musicList {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            width: 100%;
        }

        .music-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: move;
            transition: background 0.2s;
        }

        .music-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .music-item.dragging {
            opacity: 0.5;
            background: rgba(76, 175, 80, 0.3);
        }

        .music-item.drag-over {
            border-top: 3px solid #4CAF50;
        }

        .drag-handle {
            cursor: move;
            font-size: 18px;
            color: #aaa;
        }

        .music-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .music-item label {
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }

        #selectAllMusic, #selectNoMusic {
            padding: 5px 15px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #2196F3;
            color: #fff;
            margin: 5px;
        }

        #selectNoMusic {
            background: #f44336;
        }

        .music-controls {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        /* Fullscreen styles */
        body:-webkit-full-screen {
            width: 100%;
            height: 100%;
        }
        body:-moz-full-screen {
            width: 100%;
            height: 100%;
        }
        body:-ms-fullscreen {
            width: 100%;
            height: 100%;
        }
        body:fullscreen {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Preloading images...</div>
    </div>

    <div id="controls">
        <label for="folderSelect">Select starting folder (optional):</label>
        <select id="folderSelect">
            <option value="">Random Order</option>
        </select>
        
        <div class="checkbox-container">
            <input type="checkbox" id="shuffleAllCheckbox">
            <label for="shuffleAllCheckbox">Shuffle ALL images together (ignore folders)</label>
        </div>

        <div class="checkbox-container">
            <input type="checkbox" id="randomizeCheckbox" checked>
            <label for="randomizeCheckbox">Randomise images within folders</label>
        </div>

        <label for="speedSelect">Image display duration:</label>
        <select id="speedSelect">
            <option value="500">Very Very Quick (0.5 second)</option>
            <option value="1000">Very Quick (1 second)</option>
            <option value="2000">Fast (2 seconds)</option>
            <option value="3000">Medium (3 seconds)</option>
            <option value="5000" selected>Normal (5 seconds)</option>
            <option value="7000">Slow (7 seconds)</option>
            <option value="10000">Very Slow (10 seconds)</option>
        </select>

        <label>Select Music (drag to reorder):</label>
        <div class="music-controls">
            <button id="selectAllMusic">Select All</button>
            <button id="selectNoMusic">No Music</button>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="randomizeMusicCheckbox">
            <label for="randomizeMusicCheckbox">Randomize music order</label>
        </div>
        <div id="musicList">
            <p style="color: #aaa;">Loading music...</p>
        </div>
        
        <button id="startButton">Start Slideshow</button>
        
        <div style="color: #aaa; font-size: 14px; text-align: center; margin-top: 10px;">
            <p>Controls: Space/P = Pause/Play | ← → = Previous/Next</p>
        </div>
    </div>
    
    <img id="slideshow" src="" alt="Slideshow Image"/>
    <audio id="audioPlayer" preload="auto" style="display: none;"></audio>

    <script>
        const imgEl = document.getElementById("slideshow");
        const startBtn = document.getElementById("startButton");
        const folderSelect = document.getElementById("folderSelect");
        const randomizeCheckbox = document.getElementById("randomizeCheckbox");
        const shuffleAllCheckbox = document.getElementById("shuffleAllCheckbox");
        const randomizeMusicCheckbox = document.getElementById("randomizeMusicCheckbox");
        const speedSelect = document.getElementById("speedSelect");
        const controls = document.getElementById("controls");
        const musicList = document.getElementById("musicList");
        const selectAllMusicBtn = document.getElementById("selectAllMusic");
        const selectNoMusicBtn = document.getElementById("selectNoMusic");
        const audioPlayer = document.getElementById("audioPlayer");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");
        
        let images = [];
        let musicFiles = [];
        let selectedMusic = [];
        let currentMusicIndex = 0;
        let index = 0;
        let delay = 5000;
        let intervalId;
        let wakeLock = null;
        let keepAwakeInterval;
        let imageCache = new Map(); // Cache for preloaded images
        const PRELOAD_COUNT = 5; // Number of images to preload ahead
        let draggedElement = null;
        let isPaused = false;
        let slideshowStarted = false;

        // When shuffleAll is checked, disable other options
        shuffleAllCheckbox.addEventListener('change', function() {
            if (this.checked) {
                folderSelect.disabled = true;
                randomizeCheckbox.disabled = true;
                folderSelect.style.opacity = '0.5';
            } else {
                folderSelect.disabled = false;
                randomizeCheckbox.disabled = false;
                folderSelect.style.opacity = '1';
            }
        });

        // Load folder list
        async function loadFolders() {
            try {
                const response = await fetch("/api/folders/list");
                const folders = await response.json();
                
                folders.forEach(folder => {
                    const option = document.createElement("option");
                    option.value = folder;
                    option.textContent = folder;
                    folderSelect.appendChild(option);
                });
            } catch (err) {
                console.error("Error loading folders:", err);
            }
        }

        // Load music list
        async function loadMusicFiles() {
            try {
                const response = await fetch("/api/music/list");
                musicFiles = await response.json();
                
                musicList.innerHTML = '';
                
                if (musicFiles.length === 0) {
                    musicList.innerHTML = '<p style="color: #aaa;">No music files found</p>';
                    return;
                }
                
                musicFiles.forEach((file, idx) => {
                    createMusicItem(file, idx);
                });
            } catch (err) {
                console.error("Error loading music:", err);
                musicList.innerHTML = '<p style="color: #aaa;">Error loading music files</p>';
            }
        }

        function createMusicItem(file, idx) {
            const div = document.createElement("div");
            div.className = "music-item";
            div.draggable = true;
            div.dataset.file = file;
            
            const dragHandle = document.createElement("span");
            dragHandle.className = "drag-handle";
            dragHandle.innerHTML = "⋮⋮";
            
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `music-${idx}`;
            checkbox.value = file;
            
            const label = document.createElement("label");
            label.htmlFor = `music-${idx}`;
            label.textContent = file;
            
            div.appendChild(dragHandle);
            div.appendChild(checkbox);
            div.appendChild(label);
            
            // Drag and drop events
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragenter', handleDragEnter);
            div.addEventListener('dragleave', handleDragLeave);
            
            musicList.appendChild(div);
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const allItems = [...musicList.querySelectorAll('.music-item')];
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }
            }
            
            this.classList.remove('drag-over');
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            const items = musicList.querySelectorAll('.music-item');
            items.forEach(item => item.classList.remove('drag-over'));
        }

        // Select all music
        selectAllMusicBtn.addEventListener('click', () => {
            const checkboxes = musicList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        });

        // Select no music
        selectNoMusicBtn.addEventListener('click', () => {
            const checkboxes = musicList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        });

        // Get selected music in order
        function getSelectedMusic() {
            const items = musicList.querySelectorAll('.music-item');
            const selected = [];
            
            items.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            
            // Randomize if checkbox is checked
            if (randomizeMusicCheckbox.checked && selected.length > 0) {
                for (let i = selected.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [selected[i], selected[j]] = [selected[j], selected[i]];
                }
                console.log('Music randomized');
            }
            
            return selected;
        }

        // Play music playlist
        function playMusic() {
            selectedMusic = getSelectedMusic();
            
            if (selectedMusic.length === 0) {
                console.log('No music selected');
                return;
            }
            
            console.log('Playlist order:', selectedMusic);
            currentMusicIndex = 0;
            playCurrentTrack();
            
            // When track ends, play next
            audioPlayer.addEventListener('ended', () => {
                currentMusicIndex = (currentMusicIndex + 1) % selectedMusic.length;
                playCurrentTrack();
            });
        }

        function playCurrentTrack() {
            if (selectedMusic.length === 0) return;
            
            const track = selectedMusic[currentMusicIndex];
            audioPlayer.src = '/music/' + track;
            audioPlayer.load(); // Explicitly load to ensure proper buffering
            audioPlayer.play().catch(err => console.error('Audio play error:', err));
            console.log('Playing:', track);
        }

        function togglePause() {
            if (!slideshowStarted) return;
            
            isPaused = !isPaused;
            
            if (isPaused) {
                // Pause slideshow
                clearInterval(intervalId);
                
                // Pause music
                if (!audioPlayer.paused) {
                    audioPlayer.pause();
                    console.log('Music paused');
                }
                
                console.log('Slideshow paused');
            } else {
                // Resume slideshow
                intervalId = setInterval(nextImage, delay);
                
                // Resume music
                if (selectedMusic.length > 0) {
                    audioPlayer.play().catch(err => console.error('Audio resume error:', err));
                    console.log('Music resumed');
                }
                
                console.log('Slideshow resumed');
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (!slideshowStarted) return;
            
            switch(e.key) {
                case ' ':  // Spacebar
                case 'p':  // P key
                case 'P':
                    e.preventDefault();
                    togglePause();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (isPaused) {
                        nextImage();
                    }
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (isPaused) {
                        previousImage();
                    }
                    break;
            }
        });

        function previousImage() {
            index = (index - 1 + images.length) % images.length;
            showImage(index);
        }

        async function loadImages() {
            console.log('Loading images...');
            const selectedFolder = folderSelect.value;
            const randomize = randomizeCheckbox.checked;
            const shuffleAll = shuffleAllCheckbox.checked;
            
            let url = '/api/images/list?randomize=' + randomize + '&shuffleAll=' + shuffleAll;
            if (selectedFolder && !shuffleAll) {
                url += '&startFolder=' + encodeURIComponent(selectedFolder);
            }
            
            console.log('Fetching URL:', url);
            const response = await fetch(url);
            images = await response.json();
            console.log('Images loaded:', images.length);
            
            // Preload first batch of images
            preloadImages(0, Math.min(PRELOAD_COUNT, images.length));
        }

        // Preload multiple images ahead
        function preloadImages(startIndex, count) {
            for (let i = 0; i < count; i++) {
                const imageIndex = (startIndex + i) % images.length;
                const url = "/images/" + images[imageIndex];
                
                // Skip if already cached
                if (imageCache.has(url)) {
                    continue;
                }
                
                const img = new Image();
                img.onload = () => {
                    console.log('Preloaded:', images[imageIndex]);
                };
                img.onerror = () => {
                    console.error('Failed to preload:', images[imageIndex]);
                };
                img.src = url;
                imageCache.set(url, img);
            }
            
            // Clean up old cached images (keep only recent ones)
            if (imageCache.size > PRELOAD_COUNT * 2) {
                const keysToDelete = [];
                let deleteCount = 0;
                for (const key of imageCache.keys()) {
                    if (deleteCount++ < imageCache.size - PRELOAD_COUNT * 2) {
                        keysToDelete.push(key);
                    } else {
                        break;
                    }
                }
                keysToDelete.forEach(key => imageCache.delete(key));
            }
        }

        function showImage(i) {
            const url = "/images/" + images[i];
            
            // Use cached image if available
            if (imageCache.has(url)) {
                imgEl.src = imageCache.get(url).src;
            } else {
                imgEl.src = url;
            }
            
            // Preload next batch of images
            const nextBatchStart = (i + 1) % images.length;
            preloadImages(nextBatchStart, PRELOAD_COUNT);
        }

        function nextImage() {
            index = (index + 1) % images.length;
            showImage(index);
        }

        async function requestFullscreen() {
            try {
                if (document.documentElement.requestFullscreen) {
                    await document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    await document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    await document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    await document.documentElement.msRequestFullscreen();
                }
                console.log('Fullscreen active');
            } catch (err) {
                console.log('Fullscreen error:', err);
            }
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                    });
                }
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
        }

        function simulateActivity() {
            const event = new MouseEvent('mousemove', {
                view: window,
                bubbles: true,
                cancelable: true,
                clientX: 1,
                clientY: 1
            });
            document.dispatchEvent(event);
        }

        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                console.log('Exited fullscreen');
            }
        });

        startBtn.addEventListener("click", async () => {
            delay = parseInt(speedSelect.value);
            
            controls.style.display = "none";
            loadingOverlay.classList.add("active");
            document.body.style.cursor = "none";
            
            await requestFullscreen();
            await requestWakeLock();
            
            keepAwakeInterval = setInterval(simulateActivity, 30000);
            
            // Start music
            playMusic();
            
            await loadImages();
            
            // Wait for initial images to preload
            let preloadedCount = 0;
            const checkInterval = setInterval(() => {
                preloadedCount = imageCache.size;
                loadingText.textContent = `Preloading images... (${preloadedCount}/${Math.min(PRELOAD_COUNT, images.length)})`;
                
                if (preloadedCount >= Math.min(PRELOAD_COUNT, images.length) || preloadedCount >= images.length) {
                    clearInterval(checkInterval);
                    loadingOverlay.classList.remove("active");
                    
                    if (images.length > 0) {
                        slideshowStarted = true;
                        showImage(0);
                        intervalId = setInterval(nextImage, delay);
                    }
                }
            }, 100);
        });

        window.addEventListener('beforeunload', () => {
            if (wakeLock !== null) {
                wakeLock.release();
            }
            if (keepAwakeInterval) {
                clearInterval(keepAwakeInterval);
            }
        });

        // Load folders and music on page load
        loadFolders();
        loadMusicFiles();
    </script>

</body>
</html>